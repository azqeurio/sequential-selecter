name: Build macOS App

on:
  push:
    tags:
      - 'v*'       # v1.0.0 같은 버전 태그에서 트리거
  workflow_dispatch: # GitHub UI에서 수동 트리거 가능

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Python 설정
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3. Homebrew 시스템 의존성 설치 (rawpy용 libraw, pillow-heif용 libheif)
      - name: Install Homebrew dependencies
        run: |
          brew install libraw libheif

      # 4. Python 의존성 설치
      - name: Install Python dependencies
        env:
          # libheif Homebrew 경로를 pillow-heif 빌드 시 인식하도록 설정
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig
        run: |
          python -m pip install --upgrade pip
          pip install PySide6 Pillow rawpy pillow-heif==0.19.0 pyinstaller numpy

      # 5. .app 번들 빌드
      - name: Build macOS App
        env:
          # PySide6가 headless 환경에서도 임포트 가능하도록 설정
          QT_QPA_PLATFORM: offscreen
        run: |
          pyinstaller ssc_macos.spec --noconfirm --clean

      # 6. 빌드 결과물 경로 확인 (디버깅용)
      - name: List dist directory
        run: |
          find dist -type d | head -20

      # 7. .app을 zip으로 압축
      #    COLLECT 방식이라 dist/SequentialSelector/SequentialSelector.app 에 생성됨
      - name: Compress .app into zip
        run: |
          cd dist/SequentialSelector
          zip -r "../../SequentialSelector-macOS.zip" "SequentialSelector.app"
          cd ../..

      # 8. 아티팩트 업로드 (항상, 검사용)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: SequentialSelector-macOS
          path: SequentialSelector-macOS.zip
          retention-days: 14

      # 9. 버전 태그 push 시에만 GitHub Release 생성
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: SequentialSelector-macOS.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
