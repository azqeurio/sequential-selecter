name: Build macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 체크아웃된 파일 목록 확인 (디버깅)
      - name: List repo files
        run: ls -la

      # 3. Python 설정
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 4. Homebrew 시스템 의존성 설치
      - name: Install Homebrew dependencies
        run: |
          brew install libraw libheif

      # 5. Python 의존성 설치
      #    exifread: metadata.py에서 사용 (requirements.txt에 누락되어 있음)
      - name: Install Python dependencies
        env:
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig
        run: |
          python -m pip install --upgrade pip
          pip install PySide6 Pillow rawpy pillow-heif==1.2.1 exifread numpy pyinstaller

      # 6. macOS spec 파일 생성
      - name: Create macOS spec file
        run: |
          cat > ssc_macos.spec << 'EOF'
          # -*- mode: python ; coding: utf-8 -*-

          block_cipher = None

          datas = [
              ('src/i18n', 'src/i18n'),
          ]

          hiddenimports = [
              'PySide6.QtCore',
              'PySide6.QtGui',
              'PySide6.QtWidgets',
              'PySide6.QtOpenGLWidgets',
              'rawpy',
              'pillow_heif',
              'PIL',
              'PIL.Image',
              'PIL.ImageOps',
              'PIL.ImageQt',
              'PIL.ExifTags',
              'exifread',
              'numpy',
          ]

          a = Analysis(
              ['run.py'],
              pathex=['.'],
              binaries=[],
              datas=datas,
              hiddenimports=hiddenimports,
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              [],
              exclude_binaries=True,
              name='SequentialSelector',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              console=False,
              argv_emulation=True,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
          )

          coll = COLLECT(
              exe,
              a.binaries,
              a.zipfiles,
              a.datas,
              strip=False,
              upx=True,
              upx_exclude=[],
              name='SequentialSelector',
          )

          app = BUNDLE(
              coll,
              name='SequentialSelector.app',
              icon=None,
              bundle_identifier='com.ssc.sequentialselector',
              info_plist={
                  'NSPrincipalClass': 'NSApplication',
                  'NSAppleScriptEnabled': False,
                  'CFBundleDocumentTypes': [],
                  'NSHighResolutionCapable': True,
              },
          )
          EOF

      # 7. .app 번들 빌드
      - name: Build macOS App
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          pyinstaller ssc_macos.spec --noconfirm --clean

      # 8. 빌드 결과물 구조 확인 (디버깅)
      - name: List dist directory
        run: find dist -maxdepth 3

      # 9. .app을 zip으로 압축
      #    BUNDLE 방식: dist/SequentialSelector.app 에 생성됨
      - name: Compress .app into zip
        run: |
          cd dist
          zip -r "../SequentialSelector-macOS.zip" "SequentialSelector.app"
          cd ..

      # 10. 아티팩트 업로드
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: SequentialSelector-macOS
          path: SequentialSelector-macOS.zip
          retention-days: 14

      # 11. 버전 태그 push 시에만 GitHub Release 생성
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: SequentialSelector-macOS.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
